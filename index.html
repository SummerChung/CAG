<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>合約自動化生成系統</title>
    
    <!-- 修正後的函式庫連結 (關鍵修正) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/docxtemplater/3.37.11/docxtemplater.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pizzip/3.1.4/pizzip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/1.3.8/FileSaver.min.js"></script>
    <!-- 修正 PizZipUtils 的連結路徑 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pizzip-utils/0.1.1/pizzip-utils.min.js"></script>

    <style>
        body { font-family: "Microsoft JhengHei", sans-serif; background-color: #f4f4f4; padding: 20px; }
        .container { max-width: 950px; margin: 0 auto; background: #fff; padding: 30px; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        h2 { border-bottom: 2px solid #333; padding-bottom: 10px; }
        h3 { color: #0056b3; margin-top: 25px; }
        .page { display: none; }
        .page.active { display: block; }
        .form-group { margin-bottom: 15px; }
        label { display: block; font-weight: bold; margin-bottom: 5px; }
        input[type="text"], input[type="number"], select, textarea { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        .row { display: flex; gap: 10px; }
        .col { flex: 1; }
        .btn-group { margin-top: 20px; text-align: right; }
        button { padding: 10px 20px; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; }
        button:hover { background-color: #0056b3; }
        button.secondary { background-color: #6c757d; }
        button.success { background-color: #28a745; }
        button.success:hover { background-color: #218838; }
        .table-input { width: 100%; border-collapse: collapse; margin-bottom: 15px; font-size: 0.95em; }
        .table-input th, .table-input td { border: 1px solid #ddd; padding: 8px; text-align: center; vertical-align: middle; }
        .table-input th { background-color: #f8f9fa; color: #333; }
        .table-input input { text-align: center; }
        .read-only { background-color: #e9ecef; cursor: not-allowed; color: #495057; font-weight: bold; }
        .checkbox-group label { display: inline-block; margin-right: 15px; font-weight: normal; cursor: pointer; }
        .indent { margin-left: 20px; margin-top: 5px; border-left: 3px solid #eee; padding-left: 10px; }
        .hidden { display: none; }
        .required-mark { color: red; margin-left: 3px; }
        .info-box { background-color: #e2e3e5; padding: 15px; border-radius: 5px; margin-bottom: 20px; color: #383d41; border: 1px solid #d6d8db; }
    </style>
</head>
<body>

<div class="container">
    <h1>合約自動化生成程式</h1>
    
    <!-- 第一頁：合約類型 -->
    <div id="page1" class="page active">
        <h2>步驟 1/3：合約類型選擇</h2>
        <div class="form-group">
            <label>請選擇合約類型：</label>
            <div class="checkbox-group">
                <label><input type="radio" name="contractType" value="new" checked> 新簽約</label>
                <label><input type="radio" name="contractType" value="renew"> 續約</label>
            </div>
        </div>
        <div class="btn-group">
            <button onclick="nextPage(2)">下一步 &gt;</button>
        </div>
    </div>

    <!-- 第二頁：基本資料與費用 -->
    <div id="page2" class="page">
        <h2>步驟 2/3：基本資料與費用</h2>
        
        <!-- 2-1 合約期間 -->
        <h3>2-1. 合約期間</h3>
        <div class="row">
            <div class="col">
                <label>起始日期 (民國)</label>
                <div class="row">
                    <input type="number" id="startYear" placeholder="年" onchange="calcDuration()">
                    <input type="number" id="startMonth" placeholder="月" onchange="calcDuration()">
                    <input type="number" id="startDay" placeholder="日" onchange="calcDuration()">
                </div>
            </div>
            <div class="col">
                <label>結束日期 (民國)</label>
                <div class="row">
                    <input type="number" id="endYear" placeholder="年" onchange="calcDuration()">
                    <input type="number" id="endMonth" placeholder="月" onchange="calcDuration()">
                    <input type="number" id="endDay" placeholder="日" onchange="calcDuration()">
                </div>
            </div>
        </div>
        <div class="form-group" style="margin-top: 10px;">
            <label>期間計算結果 (自動產生)：</label>
            <input type="text" id="durationResult" class="read-only" readonly>
        </div>
        <div class="form-group">
            <label>封底日期 (民國)</label>
            <div class="row" style="max-width: 400px;">
                <input type="number" id="coverYear" placeholder="年">
                <input type="number" id="coverMonth" placeholder="月">
                <input type="number" id="coverDay" placeholder="日">
            </div>
        </div>

        <!-- 2-1 基本資料 -->
        <h3>基本資料</h3>
        <div class="row">
            <div class="col"><label>2-1-1 社區(大樓)名稱 <span class="required-mark">*</span></label><input type="text" id="commName" required></div>
            <div class="col"><label>2-1-2 社區(大樓)地址 <span class="required-mark">*</span></label><input type="text" id="commAddr" required></div>
        </div>
        <div class="row">
            <div class="col"><label>2-1-3 乙方 <span class="required-mark">*</span></label><input type="text" id="partyB" required></div>
            <div class="col"><label>2-1-4 代表人 <span class="required-mark">*</span></label><input type="text" id="repName" required></div>
        </div>
        <div class="row">
            <div class="col"><label>2-1-5 電話 <span class="required-mark">*</span></label><input type="text" id="phone" required></div>
            <div class="col"><label>2-1-6 統一編號</label><input type="text" id="taxId"></div>
        </div>

        <!-- 2-2 & 2-3 設備與費用 -->
        <h3>2-2 & 2-3. 設備與費用明細</h3>
        <table class="table-input">
            <thead>
                <tr>
                    <th width="20%">項目</th>
                    <th width="10%">數量(台)</th>
                    <th width="25%">安裝位置</th>
                    <th width="20%">單價(台/月)</th>
                    <th width="25%">小計(月)</th>
                </tr>
            </thead>
            <tbody>
                <!-- 序1 -->
                <tr>
                    <td>社區EIP聯網機 (序1)</td>
                    <td><input type="number" id="qty_eip_net_1" value="0" min="0" onchange="calcFees()"></td>
                    <td><input type="text" id="loc_eip_net_1" value="大廳/梯廳"></td>
                    <td><input type="number" id="price_eip_net_1" value="0" onchange="calcFees()"></td>
                    <td><input type="text" id="sub_eip_net_1" class="read-only" readonly></td>
                </tr>
                <!-- 序2 (已加入預設文字) -->
                <tr>
                    <td>社區EIP聯網機 (序2)</td>
                    <td><input type="number" id="qty_eip_net_2" value="0" min="0" onchange="calcFees()"></td>
                    <td><input type="text" id="loc_eip_net_2" value="大廳/梯廳"></td>
                    <td><input type="number" id="price_eip_net_2" value="0" onchange="calcFees()"></td>
                    <td><input type="text" id="sub_eip_net_2" class="read-only" readonly></td>
                </tr>
                <!-- 序3 -->
                <tr>
                    <td>社區EIP公告機 (序3)</td>
                    <td><input type="number" id="qty_eip_anno" value="0" min="0" onchange="calcFees()"></td>
                    <td><input type="text" id="loc_eip_anno" value="電梯車廂內"></td>
                    <td><input type="number" id="price_eip_anno" value="0" onchange="calcFees()"></td>
                    <td><input type="text" id="sub_eip_anno" class="read-only" readonly></td>
                </tr>
                <!-- 合計 -->
                <tr>
                    <td colspan="4" style="text-align: right; font-weight: bold;">合計 (月)</td>
                    <td><input type="text" id="total_monthly" class="read-only" readonly style="font-weight: bold; color: #d9534f;"></td>
                </tr>
            </tbody>
        </table>

        <!-- 2-4 帳戶資訊 (必填) -->
        <h3>2-4. 匯款帳戶 <span style="font-size:0.8em; color:red;">(此區皆為必填)</span></h3>
        <div class="row">
            <div class="col">
                <label>銀行 <span class="required-mark">*</span></label>
                <input type="text" id="bankName" placeholder="例如：台灣銀行" required>
            </div>
            <div class="col">
                <label>分行 <span class="required-mark">*</span></label>
                <input type="text" id="bankBranch" placeholder="例如：信義分行" required>
            </div>
        </div>
        <div class="row">
            <div class="col">
                <label>戶名 <span class="required-mark">*</span></label>
                <input type="text" id="acctName" required>
            </div>
            <div class="col">
                <label>帳號 <span class="required-mark">*</span></label>
                <input type="text" id="acctNum" required>
            </div>